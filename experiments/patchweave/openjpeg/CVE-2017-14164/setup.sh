project_name=openjpeg
bug_id=CVE-2017-14164
dir_name=$1/extractfix/$project_name/$bug_id

project_url=https://github.com/uclouvain/openjpeg.git
commit_id=dcac91b8

current_dir=$PWD
mkdir -p $dir_name
cd $dir_name
git clone $project_url src
cd src
git checkout $commit_id

cmake -DCMAKE_C_COMPILER=wllvm -DCMAKE_CXX_COMPILER=wllvm++ -DBUILD_SHARED_LIBS=off -DCMAKE_C_FLAGS="-g -O0" -DCMAKE_CXX_FLAGS="-g -O0"
make -j32

sed -i 's/fabs/fabs_trident/g' src/lib/openjp3d/t1.c
sed -i 's/fabs/fabs_trident/g' src/lib/openjp3d/t1_3d.c
sed -i 's/fabs/fabs_trident/g' src/lib/openjp3d/tcd.c

opj_file=src/bin/jp2/opj_compress.c
opj_input=TIF_DFMT
sed -i "s/get_file_format(infile)/$opj_input/g" $opj_file
git add $opj_file
git commit -m "fix input format"

sed -i '4220d'  src/lib/openjp2/j2k.c
sed -i '4220i TRIDENT_OUTPUT("obs", "i32", p_total_data_size);'  src/lib/openjp2/j2k.c
sed -i '4220i if(__trident_choice("L176", "bool", (int[]){p_total_data_size}, (char*[]){"x"}, 1, (int*[]){}, (char*[]){}, 0)) {'  src/lib/openjp2/j2k.c
sed -i '44i #ifndef TRIDENT_OUTPUT\n#define TRIDENT_OUTPUT(id, typestr, value) value\n#endif\n'  src/lib/openjp2/j2k.c
git add  src/lib/openjp2/j2k.c
git commit -m "instrument trident"



cd $current_dir
cp repair.conf $dir_name
cp spec.smt2 $dir_name
cp t1.smt2 $dir_name
cp -rf components $dir_name
cp exploit.bmp $dir_name

