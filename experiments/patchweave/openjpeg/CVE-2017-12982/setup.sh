project_name=openjpeg
bug_id=CVE-2017-12982
dir_name=$1/extractfix/$project_name/$bug_id

project_url=https://github.com/uclouvain/openjpeg.git
commit_id=afb308b

current_dir=$PWD
mkdir -p $dir_name
cd $dir_name
git clone $project_url src
cd src
git checkout $commit_id

cmake -DCMAKE_C_COMPILER=wllvm -DCMAKE_CXX_COMPILER=wllvm++ -DBUILD_SHARED_LIBS=off -DCMAKE_C_FLAGS="-g -O0" -DCMAKE_CXX_FLAGS="-g -O0"
make -j32

opj_file=src/bin/jp2/opj_compress.c
opj_input=BMP_DFMT
sed -i "s/get_file_format(infile)/$opj_input/g" $opj_file
git add $opj_file
git commit -m "fix input format"


sed -i '1084i parameters.decod_format = BMP_DFMT;' src/bin/jp2/opj_compress.c
sed -i '395i TRIDENT_OUTPUT("obs", "i32", header->biBitCount);' src/bin/jp2/convertbmp.c
sed -i '395i if(__trident_choice("L176", "bool", (int[]){header->biBitCount}, (char*[]){"x"}, 1, (int*[]){}, (char*[]){}, 0)) return OPJ_FALSE;' src/bin/jp2/convertbmp.c
sed -i '47i #ifndef TRIDENT_OUTPUT\n#define TRIDENT_OUTPUT(id, typestr, value) value\n#endif\n' src/bin/jp2/convertbmp.c
git add src/bin/jp2/convertbmp.c
git commit -m "instrument trident"



cd $current_dir
cp repair.conf $dir_name
cp spec.smt2 $dir_name
cp t1.smt2 $dir_name
cp -rf components $dir_name
cp exploit.bmp $dir_name

